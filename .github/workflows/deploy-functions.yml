name: DocVault – Deploy Functions

on:
  push:
    branches: [ main ]
    paths:
      - 'backend/DocVault.Functions/**'
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'
  FUNCTION_APP_NAME: 'docvault-functions-ci'
  FUNCTION_PROJECT_PATH: './backend/DocVault.Functions/DocVault.Functions.csproj'

jobs:

  # ── Build & Publish Functions ──────────────────────────
  build-functions:
    name: Build Azure Functions
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore NuGet packages
        run: dotnet restore ${{ env.FUNCTION_PROJECT_PATH }}

      - name: Build Functions (Release)
        run: dotnet build ${{ env.FUNCTION_PROJECT_PATH }} --configuration Release --no-restore

      - name: Publish Functions
        run: |
          dotnet publish ${{ env.FUNCTION_PROJECT_PATH }} \
            --configuration Release \
            --no-build \
            --output ./publish/functions

      - name: Upload Functions artifact
        uses: actions/upload-artifact@v4
        with:
          name: functions-build
          path: ./publish/functions

  # ── Deploy Functions to Azure ──────────────────────────
  deploy-functions:
    name: Deploy Functions to Azure
    runs-on: ubuntu-latest
    needs: build-functions
    if: github.ref == 'refs/heads/main' && github.event_name != 'pull_request'

    steps:
      - name: Download Functions artifact
        uses: actions/download-artifact@v4
        with:
          name: functions-build
          path: ./publish/functions

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure Functions
        uses: azure/functions-action@v2
        with:
          app-name: ${{ env.FUNCTION_APP_NAME }}
          package: ./publish/functions

      - name: Azure Logout
        if: always()
        run: az logout
